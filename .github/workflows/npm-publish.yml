name: NPM Publish

on:
  workflow_dispatch:
    inputs:
      release_type:
        description: 'Release type'
        required: true
        default: 'patch'
        type: choice
        options:
        - patch
        - minor
        - major
      release_message:
        description: 'Release message'
        required: false
        default: 'Release new version'
  push:
    branches: [main]
    paths: ['.changeset/**']

permissions:
  contents: write
  id-token: write
  packages: write

jobs:
  publish:
    name: Build and Publish to NPM
    runs-on: ubuntu-latest
    if: github.repository_owner == 'Gzeu'
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup PNPM
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'
          
      - name: Install dependencies
        run: |
          if pnpm install --frozen-lockfile; then
            echo "âœ… Installed with frozen lockfile"
          else
            echo "âš ï¸ Frozen lockfile failed, installing without it..."
            pnpm install --no-frozen-lockfile
          fi

      - name: ðŸ” Check for changes
        id: check-changes
        run: |
          if [[ -n "$(git status --porcelain)" ]]; then
            echo "changes=true" >> $GITHUB_OUTPUT
            echo "ðŸ“ Changes detected, will build and potentially publish"
          else
            echo "changes=false" >> $GITHUB_OUTPUT
            echo "â„¹ï¸ No changes detected"
          fi
          
      - name: ðŸ—ï¸ Build all packages
        run: |
          echo "ðŸ—ï¸ Building all packages..."
          pnpm run build
          echo "âœ… Build completed successfully"

      - name: ðŸ§ª Run tests
        run: |
          echo "ðŸ§ª Running tests..."
          pnpm run test
          echo "âœ… All tests passed"

      - name: ðŸ•µï¸ Check bundle sizes
        run: |
          echo "ðŸ“Š Checking bundle sizes..."
          pnpm run size || echo "âš ï¸ Size check completed with warnings"
          echo "âœ… Size check completed"

      - name: ðŸ“¦ Create Release PR or Publish
        id: changesets
        uses: changesets/action@v1
        with:
          publish: pnpm release
          commit: 'chore: release packages'
          title: 'chore: release packages'
          createGithubReleases: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: ðŸ“ˆ Generate summary
        run: |
          echo "## ðŸ“¦ NPM Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸŽ¯ Status: ${{ steps.changesets.outputs.published == 'true' && 'Published!' || 'PR Created' }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changesets.outputs.published }}" == "true" ]; then
            echo "### ðŸ“¦ Published Packages:" >> $GITHUB_STEP_SUMMARY
            echo '${{ steps.changesets.outputs.publishedPackages }}' | jq -r '.[] | "- **" + .name + "** v" + .version' >> $GITHUB_STEP_SUMMARY
          else
            echo "### ðŸ“ Next Steps:" >> $GITHUB_STEP_SUMMARY  
            echo "- Review and merge the created PR to publish packages" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸš€ Commands used:" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "pnpm build && pnpm test && pnpm release" >> $GITHUB_STEP_SUMMARY  
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
